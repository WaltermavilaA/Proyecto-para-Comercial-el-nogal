<div class="container-fluid">
  <!-- Header -->
  <div class="row bg-primary text-white py-3">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h3 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>
            Historial de Ingresos
          </h3>
          <small>Consulta y gestión de ingresos de inventario</small>
        </div>
        <div>
          <button class="btn btn-outline-light me-2" (click)="cancelar()">
            <i class="bi bi-arrow-left me-1"></i> Volver
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
      <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ totalIngresos }}</h4>
                <p class="mb-0">Total Ingresos</p>
              </div>
              <div class="align-self-center">
                <i class="bi bi-receipt" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>S/ {{ totalMonto | number:'1.2-2' }}</h4>
                <p class="mb-0">Monto Total</p>
              </div>
              <div class="align-self-center">
                <i class="bi bi-currency-dollar" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ pendientesPago }}</h4>
                <p class="mb-0">Pendientes Pago</p>
              </div>
              <div class="align-self-center">
                <i class="bi bi-clock" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card bg-secondary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4>{{ ingresos.length }}</h4>
                <p class="mb-0">Registros Totales</p>
              </div>
              <div class="align-self-center">
                <i class="bi bi-archive" style="font-size: 2rem;"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="bi bi-funnel me-2"></i>
              Filtros de Búsqueda
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Proveedor</label>
                <input type="text" class="form-control" 
                       [(ngModel)]="filtroProveedor"
                       (input)="aplicarFiltros()"
                       placeholder="Nombre del proveedor...">
              </div>
              <div class="col-md-3">
                <label class="form-label">N° Factura</label>
                <input type="text" class="form-control" 
                       [(ngModel)]="filtroFactura"
                       (input)="aplicarFiltros()"
                       placeholder="Número de factura...">
              </div>
              <div class="col-md-2">
                <label class="form-label">Estado Pago</label>
                <select class="form-select" 
                        [(ngModel)]="filtroEstadoPago"
                        (change)="aplicarFiltros()">
                  <option value="todos">Todos</option>
                  <option value="pendientes">Pendientes</option>
                  <option value="pagados">Pagados</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" 
                       [(ngModel)]="fechaInicio"
                       (change)="aplicarFiltros()">
              </div>
              <div class="col-md-2">
                <label class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" 
                       [(ngModel)]="fechaFin"
                       (change)="aplicarFiltros()">
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-12">
                <div class="d-flex justify-content-between">
                  <button class="btn btn-outline-secondary" 
                          (click)="limpiarFiltros()">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Limpiar Filtros
                  </button>
                  
                  <button class="btn btn-success" 
                          (click)="exportarExcel()"
                          [disabled]="exportando || ingresosFiltrados.length === 0">
                    <span *ngIf="exportando" class="spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-file-earmark-excel me-1" *ngIf="!exportando"></i>
                    {{ exportando ? 'Exportando...' : 'Exportar Excel' }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Ingresos -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              Historial de Ingresos
              <span class="badge bg-primary ms-2">{{ ingresosFiltrados.length }}</span>
            </h5>
            <small class="text-muted">
              Mostrando {{ ingresosFiltrados.length }} de {{ ingresos.length }} registros
            </small>
          </div>
          <div class="card-body">
            <!-- Loading -->
            <div *ngIf="cargando" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
              <p class="mt-2">Cargando historial de ingresos...</p>
            </div>

            <!-- Sin resultados -->
            <div *ngIf="!cargando && ingresosFiltrados.length === 0" class="text-center py-4">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
              <p class="mt-2 text-muted">No se encontraron ingresos</p>
              <button class="btn btn-primary" (click)="limpiarFiltros()">
                <i class="bi bi-arrow-clockwise me-1"></i>
                Limpiar filtros
              </button>
            </div>

            <!-- Tabla de ingresos -->
            <div *ngIf="!cargando && ingresosFiltrados.length > 0" class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>N° Factura</th>
                    <th>Proveedor</th>
                    <th>Fechas</th>
                    <th>Método Pago</th>
                    <th>Subtotal</th>
                    <th>IGV</th>
                    <th>Total</th>
                    <th>Estado Pago</th>
                    <th width="100">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let ingreso of ingresosFiltrados">
                    <td>
                      <strong class="text-primary">{{ ingreso.numeroFactura }}</strong>
                    </td>
                    <td>
                      <strong>{{ ingreso.proveedor.nombre }}</strong>
                      <br>
                      <small class="text-muted">{{ ingreso.proveedor.materialEspecialidad }}</small>
                    </td>
                    <td>
                      <small class="d-block">
                        <strong>Ingreso:</strong> {{ formatearFecha(ingreso.fechaIngreso) }}
                      </small>
                      <small class="d-block">
                        <strong>Emisión:</strong> {{ formatearFecha(ingreso.fechaEmision) }}
                      </small>
                      <small class="d-block text-muted" *ngIf="ingreso.metodoPago === 'credito'">
                        <strong>Vence:</strong> {{ formatearFecha(ingreso.fechaPago!) }}
                      </small>
                    </td>
                    <td>
                      <span [ngClass]="ingreso.metodoPago === 'contado' ? 'badge bg-success' : 'badge bg-info'">
                        {{ ingreso.metodoPago === 'contado' ? 'CONTADO' : 'CRÉDITO' }}
                      </span>
                      <small class="d-block text-muted" *ngIf="ingreso.metodoPago === 'credito'">
                        {{ ingreso.diasCredito }} días
                      </small>
                    </td>
                    <td>
                      <strong>S/ {{ ingreso.subtotal | number:'1.2-2' }}</strong>
                    </td>
                    <td>
                      <small class="text-muted">S/ {{ ingreso.igv | number:'1.2-2' }}</small>
                    </td>
                    <td>
                      <strong class="text-success">S/ {{ ingreso.total | number:'1.2-2' }}</strong>
                    </td>
                    <td>
                      <span [ngClass]="getClaseEstadoPago(ingreso)">
                        {{ getTextoEstadoPago(ingreso) }}
                      </span>
                    </td>
                    <td>
                      <button class="btn btn-outline-primary btn-sm" 
                              (click)="verDetalle(ingreso, modalDetalle)"
                              title="Ver detalle">
                        <i class="bi bi-eye"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalle del Ingreso -->
<ng-template #modalDetalle let-modal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="bi bi-receipt me-2"></i>
      Detalle del Ingreso
    </h5>
    <button type="button" class="btn-close" (click)="modal.dismiss()"></button>
  </div>
  
  <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
    <div *ngIf="ingresoSeleccionado">
      <!-- Información General -->
      <div class="row mb-4">
        <div class="col-md-6 mb-3">
          <h6 class="text-muted small mb-1">NÚMERO DE FACTURA</h6>
          <p class="mb-0 fw-bold text-primary">{{ ingresoSeleccionado.numeroFactura }}</p>
        </div>
        <div class="col-md-6 mb-3">
          <h6 class="text-muted small mb-1">PROVEEDOR</h6>
          <p class="mb-0 fw-bold">{{ ingresoSeleccionado.proveedor.nombre }}</p>
          <small class="text-muted">{{ ingresoSeleccionado.proveedor.materialEspecialidad }}</small>
        </div>
      </div>

      <div class="row mb-4">
        <div class="col-md-4 mb-3">
          <h6 class="text-muted small mb-1">FECHA DE EMISIÓN</h6>
          <p class="mb-0">{{ formatearFecha(ingresoSeleccionado.fechaEmision) }}</p>
        </div>
        <div class="col-md-4 mb-3">
          <h6 class="text-muted small mb-1">FECHA DE INGRESO</h6>
          <p class="mb-0">{{ formatearFecha(ingresoSeleccionado.fechaIngreso) }}</p>
        </div>
        <div class="col-md-4 mb-3">
          <h6 class="text-muted small mb-1">MÉTODO DE PAGO</h6>
          <p class="mb-0">
            <span [ngClass]="ingresoSeleccionado.metodoPago === 'contado' ? 'badge bg-success' : 'badge bg-info'">
              {{ ingresoSeleccionado.metodoPago === 'contado' ? 'CONTADO' : 'CRÉDITO' }}
            </span>
          </p>
          <small class="text-muted" *ngIf="ingresoSeleccionado.metodoPago === 'credito'">
            {{ ingresoSeleccionado.diasCredito }} días
          </small>
        </div>
      </div>

      <!-- Información de Pago -->
      <div class="alert alert-info mb-4" *ngIf="ingresoSeleccionado.metodoPago === 'credito'">
        <div class="row">
          <div class="col-md-6">
            <strong>Fecha de Vencimiento:</strong><br>
            {{ formatearFecha(ingresoSeleccionado.fechaPago!) }}
          </div>
          <div class="col-md-6">
            <strong>Estado:</strong><br>
            <span [ngClass]="getClaseEstadoPago(ingresoSeleccionado)">
              {{ getTextoEstadoPago(ingresoSeleccionado) }}
            </span>
          </div>
        </div>
      </div>

      <hr>

      <!-- Productos -->
      <div class="mb-4">
        <h6 class="mb-3">
          <i class="bi bi-box-seam me-2"></i>
          Productos Ingresados ({{ ingresoSeleccionado.detalles.length }})
        </h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">Precio Compra</th>
                <th class="text-end">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detalle of ingresoSeleccionado.detalles">
                <td>
                  <strong>{{ detalle.producto.nombre }}</strong>
                  <br>
                  <small class="text-muted">
                    {{ detalle.producto.categoria?.nombre }} • {{ detalle.producto.material }}
                  </small>
                </td>
                <td class="text-center">
                  <span class="badge bg-secondary">{{ detalle.cantidad }}</span>
                </td>
                <td class="text-end">
                  S/ {{ detalle.precioCompra | number:'1.2-2' }}
                </td>
                <td class="text-end">
                  <strong>S/ {{ detalle.subtotal | number:'1.2-2' }}</strong>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Resumen de Costos -->
      <div class="detalle-resumen bg-light p-3 rounded">
        <div class="row mb-2">
          <div class="col-6">
            <strong>Subtotal:</strong>
          </div>
          <div class="col-6 text-end">
            S/ {{ ingresoSeleccionado.subtotal | number:'1.2-2' }}
          </div>
        </div>
        <div class="row mb-2">
          <div class="col-6">
            <strong>IGV (18%):</strong>
          </div>
          <div class="col-6 text-end">
            S/ {{ ingresoSeleccionado.igv | number:'1.2-2' }}
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-6">
            <strong class="fs-5">Total:</strong>
          </div>
          <div class="col-6 text-end">
            <strong class="fs-5 text-primary">S/ {{ ingresoSeleccionado.total | number:'1.2-2' }}</strong>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">
      Cerrar
    </button>
  </div>
</ng-template>